---
title: "deploying-spacy-in-r"
description: |
  A short description of the post.
author:
  - name: Amanda Whitmire
    url: https://amandawhitmire.github.io/
    affiliation: Stanford Libraries & Hopkins Marine Station
date: 08-18-2021
collections:
  posts:
    disqus: deploying-spacy-in-r
    share: [twitter, facebook]
output:
  distill::distill_article:
    self_contained: false
    
draft: true
preview: https://raw.githubusercontent.com/amandawhitmire/blog/main/images/xyz.jpg
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1. Set up to use `reticulate` 

The first thing you need to do is configure Python on your machine. Reticulate will connect with a local Python instance of your choosing, so consider setting up an environment that is specific to your project. I set up a Python environment that I'd like to use in the terminal via the follwoing `create` and `activate` steps:

<aside>
I named this environment 'leading2' because I totally hosed my first environment. 

It happens!
</aside>

`conda create --name leading2`
`conda activate leading2`

You can install the Python packages that you need to use via the terminal, or you can use Anaconda (or whatever install method you like! People have feelings about this!)^[These [instructions](https://support.rstudio.com/hc/en-us/articles/360023654474-Installing-and-Configuring-Python-with-RStudio) are fairly straightforward.]. In my case, I installed spaCy and pandas, and I'm going to go with that until I get an error message that I forgot something. :woman_shrugging

To specify which Python environment I'd like `reticulate` to use, I put the following line in my .Rprofile file:

`Sys.setenv(RETICULATE_PYTHON =`
`"/Users/thalassa/opt/anaconda3/envs/leading2/bin/python")`

** Note, there is an R package "[wrapper](http://spacyr.quanteda.io/)" for using spaCy in R (`spacyr`), but it's not clear to me that it is still under active development. This is important because the recent release of spaCy 3.0 introduced some significant improvements that I want to be able to take advantage of. I also need to use a custom entity set for NER, and there is an open issue on this in the `spacyr` GitHub project. I'll keep an eye on it, but I'm going to power on without the wrapper package (for now).

```{r echo=TRUE}
library(reticulate)
library(tidyverse)
```

## Import Python libraries and load spaCy

```{python echo=TRUE}
import spacy
import pandas as pd
nlp = spacy.load('en_core_web_trf')

# Import the Entity Ruler for making custom entities
from spacy.pipeline import EntityRuler
```

Let's run spaCy and see what happens!

First, pass an R variable to Python via the `r_to_py` function.

```{r echo=TRUE}
pyocr <- reticulate::r_to_py(ocr)
```

```{python}
dfner = nlp(r.text)
```

